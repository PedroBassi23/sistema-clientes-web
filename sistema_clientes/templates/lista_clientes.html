{% extends 'base.html' %}

{% block title %}Lista de Clientes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Clientes</h1>
    <div class="btn-toolbar mb-2 mb-md-0 gap-2">
        <a href="{{ url_for('exportar_clientes') }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel-fill"></i> Exportar
        </a>
        <a href="{{ url_for('novo_cliente') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle-fill"></i> Novo Cliente
        </a>
    </div>
</div>

<!-- FORMULÁRIO DE BUSCA E FILTRO -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="{{ url_for('listar_clientes') }}" class="row g-3 align-items-center">
            <!-- Campo de Busca -->
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="search" class="form-control" name="q" id="q" placeholder="Pesquisar em todos os campos..." value="{{ search_atual or '' }}">
                </div>
            </div>

            <!-- Filtro de Status -->
            <div class="col-md-3">
                <select name="status" id="status" class="form-select">
                    <option value="Todos" {% if status_atual == 'Todos' or not status_atual %}selected{% endif %}>Filtrar por Status</option>
                    <option value="A Pagar" {% if status_atual == 'A Pagar' %}selected{% endif %}>A Pagar</option>
                    <option value="Pago" {% if status_atual == 'Pago' %}selected{% endif %}>Pago</option>
                    <option value="Parcial" {% if status_atual == 'Parcial' %}selected{% endif %}>Parcial</option>
                </select>
            </div>
            
            <!-- Botão de Ação -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-secondary w-100">
                    <i class="bi bi-funnel-fill"></i> Aplicar Filtro
                </button>
            </div>
             <!-- Botão para Limpar -->
            <div class="col-md-2">
                <a href="{{ url_for('listar_clientes') }}" class="btn btn-outline-secondary w-100">
                    Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Nome</th>
                    <th scope="col">Contato</th>
                    <th scope="col">Valor a Pagar</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody id="clientTableBody">
                {% for cliente in clientes %}
                <tr>
                    <td>
                        <div class="fw-bold">{{ cliente.nome }}</div>
                        {% if cliente.data_vencimento and cliente.status_pagamento != 'Pago' %}
                            <small class="text-muted">
                                Venc: {{ cliente.data_vencimento.strftime('%d/%m/%Y') }}
                                {% if cliente.data_vencimento == hoje %}
                                    <span class="badge bg-danger">HOJE</span>
                                {% elif cliente.data_vencimento < hoje %}
                                    <span class="badge bg-danger">VENCIDO</span>
                                {% endif %}
                            </small>
                        {% endif %}
                    </td>
                    <td>
                        <div>{{ cliente.email }}</div>
                        <small class="text-muted">{{ cliente.telefone }}</small>
                    </td>
                    <td>R$ {{ "%.2f"|format(cliente.valor_a_pagar)|replace('.', ',') }}</td>
                    <td>
                        {% set status_map = {
                            'Pago': 'success',
                            'A Pagar': 'warning',
                            'Parcial': 'info'
                        } %}
                        <span class="badge text-bg-{{ status_map.get(cliente.status_pagamento, 'secondary') }}">{{ cliente.status_pagamento }}</span>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal" data-bs-target="#clienteModal{{ cliente.id }}" title="Ver Anotações">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                        <a href="{{ url_for('editar_cliente', id=cliente.id) }}" class="btn btn-sm btn-outline-primary me-1" title="Editar">
                            <i class="bi bi-pencil-fill"></i>
                        </a>
                        <form action="{{ url_for('excluir_cliente', id=cliente.id) }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este cliente?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr class="no-results-row">
                    <td colspan="5" class="text-center py-4">
                        {% if search_atual %}
                            Nenhum cliente encontrado para a busca <strong>"{{ search_atual }}"</strong>.
                        {% else %}
                            Nenhum cliente cadastrado.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr id="js-no-results" style="display: none;">
                    <td colspan="5" class="text-center py-4">Nenhum cliente corresponde à sua pesquisa.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modais de Anotações (permanece o mesmo) -->
{% for cliente in clientes %}
<div class="modal fade" id="clienteModal{{ cliente.id }}" tabindex="-1" aria-labelledby="clienteModalLabel{{ cliente.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="clienteModalLabel{{ cliente.id }}">Anotações de {{ cliente.nome }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if cliente.anotacoes %}
            {{ cliente.anotacoes|nl2br }}
        {% else %}
            <p class="text-muted">Nenhuma anotação para este cliente.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('q');
    const tableBody = document.getElementById('clientTableBody');
    const jsNoResultsRow = document.getElementById('js-no-results');
    
    // Pega todas as linhas, exceto as de "nenhum resultado"
    const dataRows = Array.from(tableBody.querySelectorAll('tr:not(.no-results-row):not(#js-no-results)'));

    // Só ativa o filtro se houver dados na tabela
    if(dataRows.length > 0) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleRowsCount = 0;

            dataRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(searchTerm)) {
                    row.style.display = ''; // Mostra a linha
                    visibleRowsCount++;
                } else {
                    row.style.display = 'none'; // Esconde a linha
                }
            });

            // Mostra/esconde a mensagem de "nenhum resultado" do JS
            if (visibleRowsCount === 0) {
                jsNoResultsRow.style.display = ''; 
            } else {
                jsNoResultsRow.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}

